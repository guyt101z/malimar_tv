<% content_for :title, 'Support | My Tickets' %>
<div class='col-xs-12 ticket_nav'>
	<%= link_to 'My Tickets', admin_support_path, class: 'active' %>
	<%= link_to 'New Tickets', admin_new_tickets_path, class: '' %>
	<%= link_to 'Archive', admin_archived_tickets_path, class: '' %>
</div>
<div class='container' style='margin-top: 60px;'>
	<div class='row'>
		<div class='col-md-6'>
			<div class='panel panel-info'>
				<div class='panel-heading'>
					<h3 class='panel-title'>Open Tickets</h3>
				</div>
				<div class='panel-body' style='padding:0'>
					<div class='tickets' id='open_tickets'>
						<% @open_cases.each do |ticket| %>
						<div id='ticket_<%= ticket.id %>' class='ticket' onclick='viewTicket(<%= ticket.id %>)'>
							<p class='title'><%= ticket.title %></p>
							<p class='timestamp'><%= custom_time_ago(ticket.created_at) %></p>
							<p><%= ticket.issue_description.truncate(80) %></p>
							<div class='row' style='margin:0'>
								<div class='col-sm-6' style='padding-left:0'>
									<p class='detail'>
										<% priorities = ['Low',     'Medium',  'High'] %>
	                                	<% classes =    ['success', 'warning', 'danger'] %>
										<strong>Priority:</strong><br>
										<span class='text-<%= classes[ticket.priority] %>'><%= priorities[ticket.priority] %></span>
									</p>
								</div>
								<div class='col-sm-6' style='padding-right:0'>
									<p class='detail'>
										<strong>Category:</strong><br>
										<%= ticket.category %>
									</p>
								</div>
							</div>
						</div>
						<% end %>
					</div>
				</div>
			</div>
		</div>
		<div class='col-md-6'>
			<div class='panel panel-success'>
				<div class='panel-heading'>
					<h3 class='panel-title'>Closed Tickets</h3>
				</div>
				<div class='panel-body' style='padding:0'>
					<div class='tickets' id='closed_tickets'>
						<% @closed_cases.each do |ticket| %>
						<div id='ticket_<%= ticket.id %>' class='ticket' onclick='viewTicket(<%= ticket.id %>)'>
							<p class='title'><%= ticket.title %></p>
							<p class='timestamp'><%= custom_time_ago(ticket.created_at) %></p>
							<p><%= ticket.issue_description.truncate(80) %></p>
							<div class='row' style='margin:0'>
								<div class='col-sm-6' style='padding-left:0'>
									<p class='detail'>
										<% priorities = ['Low',     'Medium',  'High'] %>
	                                	<% classes =    ['success', 'warning', 'danger'] %>
										<strong>Priority:</strong><br>
										<span class='text-<%= classes[ticket.priority] %>'><%= priorities[ticket.priority] %></span>
									</p>
								</div>
								<div class='col-sm-6' style='padding-right:0'>
									<p class='detail'>
										<strong>Category:</strong><br>
										<%= ticket.category %>
									</p>
								</div>
							</div>
						</div>
						<% end %>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<%= render('support/partials/support_modal_admin') %>

<script type="text/javascript">
var chatListener = ''
function testAddMessage(){
	$('#messages').prepend("<div class='message animated bounceIn'><div class='admin_message'><p class='title'>Josh Tate said:</p><p class='timestamp'><em>Just now</em></p><p>"+ $('#message').val() +"</p></div></div>")
}
function viewTicket(id) {
	$.ajax({
		url: '<%= admin_view_ticket_path %>?id='+id

	})
	.done(function(){
		if (chatListener != ''){
			chatListener.close()
		}
		chatListener = new EventSource('/events/admin/'+id)
		chatListener.addEventListener ('message', function(e) {
			var message = $.parseJSON(e.data)
			if (message.kind == 'message') {
				$('#ticket_messages').prepend("<div class='message animated fadeIn'><div class='recv_message'><p class='title'>"+message.name+" said:</p><p class='timestamp'><em class='timeago' title='"+message.timestamp+"'></em></p><p>"+Autolinker.link(message.message)+"</p></div></div>")
				$('.timeago').timeago()
			}
			else if (message.kind == 'file') {
				$('#ticket_messages').prepend("<div class='message animated fadeIn'><div class='recv_message'><p class='title'>"+message.name+" said:</p><p class='timestamp'><em class='timeago' title='"+message.timestamp+"'></em></p><p>"+Autolinker.link(message.message)+"</p></div></div>")
				$('.timeago').timeago()
				$('#ticket_attachments').prepend('<div class="col-md-3 col-sm-4 col-xs-6 support_image_wrapper"><a href="'+message.file_url+'" target="new"><img src="'+message.file_url+'" /></a></div>')
			}
		})
	})
}
$('#support_modal').on('hidden.bs.modal', function () {
	if (chatListener != ''){
		chatListener.close()
	}
})
<% if params[:id].present? %>
$('#ticket_<%= params[:id] %>').click()
<% end %>
</script>
