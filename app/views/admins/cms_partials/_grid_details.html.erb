<%
filter_params = Hash.new
unless @category.content_type.blank?
    filter_params[:content_type] = @category.content_type
end

unless @category.content_quality.blank?
    filter_params[:content_quality] = @category.content_quality
end

filter_params[:free] = @category.free

if @category.item_type == 'shows'
    if @category.sort.nil? || @category.sort == 'Alphabetical'
        all_items = Show.where(filter_params).order(name: :asc)
    elsif @category.sort == 'New Arrivals/Episodes'
        unsorted_items = Show.where(filter_params)
        hashed_items = Hash.new
        unsorted_items.each do |item|
            hashed_items[item.id] = item.newest_episode
        end
        hashed_items.sort_by {|_key, value| value}

        all_items = Array.new
        hashed_items.each do |k,v|
            all_items.push(Show.find(k))
        end
        all_items.reverse!
    elsif @category.sort == 'Random'
        all_items = Show.where(filter_params).order('rand()')
    end
    filtered_items = Array.new

    unless @category.genre.blank?
        all_items.each do |item|
            filtered_items.push(item) if item.matches_genre?(@category.genre)
        end
    else
        filtered_items = all_items
    end
elsif @category.item_type == 'movies'
    if @category.sort.nil? || @category.sort == 'Alphabetical'
        all_items = Movie.where(filter_params.except(:content_type)).order(name: :asc)
    elsif @category.sort == 'New Arrivals/Episodes'
        all_items = Movie.where(filter_params.except(:content_type)).order(release_date: :desc)
    elsif @category.sort == 'Random'
        all_items = Movie.where(filter_params.except(:content_type)).order('rand()')
    end
    filtered_items = Array.new

    unless @category.genre.blank?
        all_items.each do |item|
            filtered_items.push(item) if item.matches_genre?(@category.genre)
        end
    else
        filtered_items = all_items
    end
else
    if @category.sort.nil? || @category.sort == 'Alphabetical'
        all_items = Channel.where(filter_params).order(name: :asc)
    elsif @category.sort == 'New Arrivals/Episodes'
        all_items = Channel.where(filter_params).order(created_at: :desc)
    elsif @category.sort == 'Random'
        all_items = Channel.where(filter_params).order('rand()')
    end
    filtered_items = Array.new

    unless @category.genre.blank?
        all_items.each do |item|
            filtered_items.push(item) if item.matches_genre?(@category.genre)
        end
    else
        filtered_items = all_items
    end
end
%>

<div class='col-xs-12'>
    <div class='panel panel-default'>
        <div class='panel-heading' style='position:relative'>
            <h3 class='panel-title'><%= @category.rank %> | <%= @category.name %> <% if @category.front_page? %>(On Front Page)<% end %></h3>
            <div class='upload_image_heading'>
                <%= link_to 'Delete Grid', delete_grid_path(id: @category.id), class: 'btn btn-danger btn-sm', data: {confirm: 'Are you sure you want to delete this grid?'}, remote: true %>
                <%= link_to 'Edit Grid', view_grid_path(id: @category.id), class: 'btn btn-primary btn-sm', remote: true %>
            </div>
        </div>
        <div class='panel-body grid_body'>
            <div class='row'>
            <% filtered_items.each do |item| %>
            <div class=' col-lg-2 col-sm-3 col-xs-6'>
                <div class='movie_wrapper'>
                    <div class='image_wrapper'>
                        <%= image_tag item.image_url %>
                    </div>
                    <div class='title_wrapper'>
                        <%= item.name %>
                    </div>
                </div>
            </div>
            <% end %>
            </div>
        </div>
    </div>
</div>
